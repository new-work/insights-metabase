---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "<%= name %>"
  namespace: insights
  annotations:
    com.xing.deployment-restart: enabled
  labels:
    deploymentName: metabase
spec:
  revisionHistoryLimit: 5
  replicas: <%= replicas %>
  selector:
    matchLabels:
      app: "<%= name %>"
  # nginx-ingress-controller config update interval is 3 seconds
  minReadySeconds: 4
  strategy:
    rollingUpdate:
      maxUnavailable: <%= replicas == 1 ? 0 : 1 %>
      maxSurge: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: "<%= name %>"
      annotations:
        com.xing.ci-deployment.timestamp: "<%= deployment_id %>"
        com.xing.logjam.app.name: "<%= logjam_name %>"
    spec:
      terminationGracePeriodSeconds: 60
      imagePullSecrets:
      - name: quay-pull-secret
      containers:
      - name: "<%= name %>"
        image: <%= "quay.dc.xing.com/insights/metabase:#{tag}" %>
        args: <%= args %>
        ports:
        - containerPort: 3000
        envFrom: <%= partial "envFrom" %>
        <% if defined?(environment) && !environment.empty? %>
        env: [<%= environment.map { |k,v| %Q({name: "#{k.to_s}", value: "#{v.to_s}"}) }.join(",") %>]
        <% end %>
        resources:
          requests:
            cpu: '<%= cpu %>'
            memory: '<%= memory %>'
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          failureThreshold: 6
          initialDelaySeconds: 120
          periodSeconds: 5
          timeoutSeconds: 30
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          failureThreshold: 3
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "mkdir -p /virtual/lb_check/ && echo ALIVE > /virtual/lb_check/alive.txt"]
          preStop:
            exec:
              # sleep >3s is necessary to let nginx ingress controller remove the endpoint
              command: ["/bin/sleep", "4"]
